stage('build authenticator and app') {
    node('docker_slave-centos-7.5-x86_64') {
        git([url: 'https://github.com/jacderida/safe_client_libs.git', branch: 'docker_build'])
        build_safe_client_libs('real')
        build_safe_client_libs('mock')
    }
}

def build_safe_client_libs(mode) {
    def user_id = sh(returnStdout: true, script: 'echo $UID').trim()
    def group_id = sh(returnStdout: true, script: $/eval 'getent group $USER | awk -F : "{ print \$3 }"'/$).trim()
    sh("docker run --name safe_client_libs_${mode} " +
       "-v ${env.WORKSPACE}:/usr/src/crust:Z " +
       "-u ${user_id}:${group_id} " +
       "maidsafe/safe-client-libs-build:0.9.0 scripts/build-${mode} /target")
    sh("mkdir -p target/deploy/${mode}")
    sh("docker cp safe_client_libs_${mode}:/target/release target/deploy/${mode}")
    sh("docker rm safe_client_libs_${mode}")
}
